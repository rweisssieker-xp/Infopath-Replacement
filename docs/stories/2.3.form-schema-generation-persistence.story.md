# Story 2.3: Form Schema Generation and Persistence

## Status

Draft

## Story

**As a** form builder,
**I want** to save my form design,
**so that** I can reuse and edit forms later.

## Acceptance Criteria

1. "Save Form" button in form builder toolbar
2. Form metadata dialog: Name, Description, Category (optional)
3. Form schema generated from canvas components (JSON Schema format)
4. API integration: form saved via GraphQL mutation or REST API
5. Success notification after save
6. Error handling: display error message if save fails
7. Form loading: load existing form into builder for editing
8. Form versioning: track form versions (basic implementation)
9. Form status management: Draft, Published, Archived
10. Form list view: display all saved forms with metadata

## Tasks / Subtasks

- [ ] Task 1: Add Save Form Button to Toolbar (AC: 1)
  - [ ] Create form builder toolbar component
  - [ ] Add "Save Form" button
  - [ ] Add "New Form" button
  - [ ] Add "Load Form" button
  - [ ] Style toolbar with appropriate icons

- [ ] Task 2: Implement Form Metadata Dialog (AC: 2)
  - [ ] Create modal/dialog component for form metadata
  - [ ] Add Name input field (required)
  - [ ] Add Description textarea (optional)
  - [ ] Add Category dropdown/input (optional)
  - [ ] Add form validation
  - [ ] Handle dialog open/close state

- [ ] Task 3: Implement Form Schema Generation (AC: 3)
  - [ ] Create formSchemaGenerator utility
  - [ ] Convert form components to JSON Schema format
  - [ ] Map component types to JSON Schema types
  - [ ] Generate properties object from components
  - [ ] Generate required fields array
  - [ ] Handle nested components (if supported)
  - [ ] Validate generated schema

- [ ] Task 4: Implement API Integration for Saving Forms (AC: 4)
  - [ ] Create GraphQL client or REST API client
  - [ ] Implement createForm mutation/API call
  - [ ] Implement updateForm mutation/API call
  - [ ] Pass form metadata and schema to API
  - [ ] Handle authentication token
  - [ ] Handle API errors

- [ ] Task 5: Implement Success Notification (AC: 5)
  - [ ] Show success toast/notification after save
  - [ ] Display form ID or name in notification
  - [ ] Auto-dismiss notification after 3 seconds
  - [ ] Use Material-UI Snackbar or Ant Design notification

- [ ] Task 6: Implement Error Handling (AC: 6)
  - [ ] Catch API errors
  - [ ] Display error message in notification
  - [ ] Handle network errors
  - [ ] Handle validation errors from API
  - [ ] Provide retry option for failed saves

- [ ] Task 7: Implement Form Loading (AC: 7)
  - [ ] Create form list view/page
  - [ ] Fetch forms from API (GraphQL query or REST)
  - [ ] Display form list with metadata
  - [ ] Add "Edit" button for each form
  - [ ] Load form schema into builder
  - [ ] Convert JSON Schema back to form components
  - [ ] Populate canvas with loaded components

- [ ] Task 8: Implement Form Versioning (AC: 8)
  - [ ] Track form version in metadata
  - [ ] Increment version on save (if form exists)
  - [ ] Display version in form metadata
  - [ ] Store version history (basic implementation)

- [ ] Task 9: Implement Form Status Management (AC: 9)
  - [ ] Add status field to form metadata
  - [ ] Set default status to "Draft"
  - [ ] Add "Publish" button to toolbar
  - [ ] Add "Archive" button to toolbar
  - [ ] Update form status via API
  - [ ] Display status badge in form list

- [ ] Task 10: Implement Form List View (AC: 10)
  - [ ] Create forms list page/component
  - [ ] Fetch all forms from API
  - [ ] Display form cards with metadata (name, description, category, status, version)
  - [ ] Add search/filter functionality
  - [ ] Add pagination
  - [ ] Add "Create New Form" button
  - [ ] Add "Edit" and "Delete" actions

## Dev Notes

### Previous Story Insights

From Story 2.1:
- Form Builder UI Foundation is implemented
- Canvas and component palette are functional

From Story 2.2:
- Component properties are configurable
- Form components have all necessary properties

### Data Models

**Form Metadata Structure:**
```typescript
interface FormMetadata {
  id?: string;
  name: string;
  description?: string;
  category?: string;
  version: string;
  status: 'Draft' | 'Published' | 'Archived';
  createdAt?: Date;
  updatedAt?: Date;
}

interface FormSchema {
  type: 'object';
  properties: Record<string, JsonSchemaProperty>;
  required: string[];
}
```

[Source: docs/architecture.md#data-models]

### API Specifications

**GraphQL Mutations:**
```graphql
mutation CreateForm($input: CreateFormInput!) {
  createForm(input: $input) {
    id
    name
    version
    status
  }
}

mutation UpdateForm($id: ID!, $input: UpdateFormInput!) {
  updateForm(id: $id, input: $input) {
    id
    name
    version
    status
  }
}

query Forms($filter: FormFilter, $pagination: Pagination) {
  forms(filter: $filter, pagination: $pagination) {
    items {
      id
      name
      description
      category
      status
      version
      createdAt
      updatedAt
    }
    totalCount
    page
    pageSize
  }
}

query Form($id: ID!) {
  form(id: $id) {
    id
    name
    description
    schema
    version
    status
  }
}
```

[Source: docs/architecture.md#graphql-api-specification]

### File Locations

**Form Schema Generation and API Integration:**
```
apps/web-app/src/
├── pages/
│   ├── FormBuilder/
│   │   ├── FormBuilderPage.tsx
│   │   └── FormMetadataDialog.tsx
│   └── FormsList/
│       └── FormsListPage.tsx
├── utils/
│   ├── formSchemaGenerator.ts     # Generate JSON Schema from components
│   └── formSchemaParser.ts        # Parse JSON Schema to components
├── services/
│   └── formService.ts             # GraphQL/REST API client for forms
└── stores/
    └── formBuilderStore.ts        # Form builder state management
```

[Source: docs/architecture/source-tree.md]

### Technical Constraints

**Technology Stack:**
- Frontend Framework: React 18+ with TypeScript [Source: docs/architecture/tech-stack.md]
- GraphQL Client: Apollo Client or urql [Source: docs/architecture/tech-stack.md]
- UI Library: Material-UI or Ant Design [Source: docs/architecture/tech-stack.md]

**JSON Schema Format:**
- Follow JSON Schema Draft 7 or Draft 2020-12 specification
- Map component types to JSON Schema types:
  - Text Input → `string`
  - Number Input → `number` or `integer`
  - Date Picker → `string` with `format: "date"`
  - Dropdown → `string` with `enum`
  - Checkbox → `boolean`
  - Radio → `string` with `enum`
  - Textarea → `string`

**Environment Variables Required:**
- `VITE_GRAPHQL_GATEWAY_URL` - GraphQL Gateway endpoint
- `VITE_AUTH_SERVICE_URL` - Auth Service endpoint (for authentication)

[Source: docs/architecture.md#development-workflow]

## Testing

### Testing Standards

**Test File Location:**
- Frontend unit tests: `apps/web-app/src/utils/__tests__/`
- Component tests: `apps/web-app/src/pages/FormBuilder/__tests__/`

**Testing Frameworks:**
- Frontend: Vitest + React Testing Library [Source: docs/architecture/tech-stack.md]

**Testing Patterns:**
- Unit tests for formSchemaGenerator utility
- Unit tests for formSchemaParser utility
- Component tests for FormMetadataDialog
- Integration tests for form save/load flow
- Test JSON Schema generation accuracy
- Test form loading from API

**Test Coverage Target:** >80% for business logic [Source: docs/architecture.md#testing-strategy]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent - will list all files created/modified during implementation_

## QA Results

_This section will be populated by the QA Agent after review_


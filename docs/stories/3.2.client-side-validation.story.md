# Story 3.2: Client-Side Validation

## Status

Draft

## Story

**As a** form user,
**I want** immediate feedback when I enter invalid data,
**so that** I can correct errors before submitting.

## Acceptance Criteria

1. Real-time validation: validate field on blur (when user leaves field)
2. Validation rules from form schema enforced:
   - Required fields: show error if empty
   - Pattern validation: regex patterns for text fields
   - Min/Max validation: number and date ranges
   - Email format validation
   - URL format validation
3. Error messages displayed inline below invalid fields
4. Error messages are user-friendly (not technical, explain what's wrong)
5. Visual indicators: invalid fields show red border, valid fields show green checkmark (optional)
6. Form-level validation: "Submit" button disabled if form has errors
7. Validation summary: list of all errors at top of form (optional, for long forms)
8. Custom validation messages: form builder can define custom error messages per field
9. Async validation support: validate against server (e.g., check if email exists)
10. Validation state persists during form editing (errors don't disappear until fixed)

## Tasks / Subtasks

- [ ] Task 1: Implement Real-Time Validation (AC: 1)
  - [ ] Add onBlur handler to form fields
  - [ ] Trigger validation when field loses focus
  - [ ] Store validation state per field
  - [ ] Update validation state on field change

- [ ] Task 2: Implement Required Field Validation (AC: 2)
  - [ ] Check if field is in required array from schema
  - [ ] Validate field is not empty
  - [ ] Show error if required field is empty
  - [ ] Clear error when field is filled

- [ ] Task 3: Implement Pattern Validation (AC: 2)
  - [ ] Extract pattern from schema property
  - [ ] Validate text field against regex pattern
  - [ ] Show error if pattern doesn't match
  - [ ] Support custom regex patterns

- [ ] Task 4: Implement Min/Max Validation (AC: 2)
  - [ ] Validate number fields against min/max
  - [ ] Validate date fields against minDate/maxDate
  - [ ] Validate string length against minLength/maxLength
  - [ ] Show appropriate error messages

- [ ] Task 5: Implement Email Format Validation (AC: 2)
  - [ ] Detect email format from schema
  - [ ] Validate email format using regex
  - [ ] Show error for invalid email format
  - [ ] Use standard email validation pattern

- [ ] Task 6: Implement URL Format Validation (AC: 2)
  - [ ] Detect URL format from schema
  - [ ] Validate URL format
  - [ ] Show error for invalid URL format
  - [ ] Support http, https, ftp protocols

- [ ] Task 7: Implement Error Message Display (AC: 3, 4)
  - [ ] Display error message below invalid field
  - [ ] Style error messages consistently
  - [ ] Translate technical errors to user-friendly messages
  - [ ] Support custom error messages from schema

- [ ] Task 8: Implement Visual Indicators (AC: 5)
  - [ ] Add red border to invalid fields
  - [ ] Add green checkmark to valid fields (optional)
  - [ ] Add error icon next to invalid fields
  - [ ] Animate visual state changes

- [ ] Task 9: Implement Form-Level Validation (AC: 6)
  - [ ] Track all field validation states
  - [ ] Disable Submit button if any errors exist
  - [ ] Show error count in Submit button (optional)
  - [ ] Enable Submit button when all fields valid

- [ ] Task 10: Implement Validation Summary (AC: 7)
  - [ ] Create validation summary component
  - [ ] List all validation errors at top of form
  - [ ] Make errors clickable to scroll to field
  - [ ] Show/hide summary based on form length
  - [ ] Update summary dynamically

- [ ] Task 11: Implement Custom Validation Messages (AC: 8)
  - [ ] Support custom error messages in schema
  - [ ] Override default messages with custom ones
  - [ ] Support field-specific custom messages
  - [ ] Fallback to default messages if custom not provided

- [ ] Task 12: Implement Async Validation (AC: 9)
  - [ ] Add async validation support to form renderer
  - [ ] Create async validation service
  - [ ] Show loading state during async validation
  - [ ] Handle async validation errors
  - [ ] Example: email uniqueness check

- [ ] Task 13: Implement Validation State Persistence (AC: 10)
  - [ ] Persist validation state in form state
  - [ ] Keep errors visible until field is corrected
  - [ ] Clear errors only when field becomes valid
  - [ ] Maintain validation state during form editing

## Dev Notes

### Previous Story Insights

From Story 3.1:
- Form Runtime Rendering Engine is implemented
- Form fields are rendered from JSON Schema
- Form state management is in place

### Data Models

**Validation Rules from JSON Schema:**
```typescript
interface ValidationRule {
  required?: boolean;
  pattern?: string;
  minLength?: number;
  maxLength?: number;
  minimum?: number;
  maximum?: number;
  format?: 'email' | 'uri' | 'date' | 'date-time';
  customMessage?: string;
}
```

[Source: docs/architecture.md#data-models]

### File Locations

**Validation Implementation:**
```
apps/web-app/src/
├── utils/
│   ├── formValidators.ts          # Validation functions
│   └── validationMessages.ts     # Error message mapping
├── hooks/
│   └── useFormValidation.ts      # Validation hook
└── components/
    └── form-runtime/
        └── ValidationError.tsx   # Error display component
```

[Source: docs/architecture/source-tree.md]

### Technical Constraints

**Technology Stack:**
- Frontend Framework: React 18+ with TypeScript [Source: docs/architecture/tech-stack.md]
- Validation Library: Zod or Yup (optional, can use custom) [Source: docs/architecture/tech-stack.md]
- UI Library: Material-UI or Ant Design [Source: docs/architecture/tech-stack.md]

**Validation Patterns:**
- Validate on blur (when field loses focus)
- Show errors inline below fields
- Disable submit if errors exist
- Support async validation for server-side checks

**Environment Variables Required:**
- None specific to this story

[Source: docs/architecture.md#development-workflow]

## Testing

### Testing Standards

**Test File Location:**
- Frontend unit tests: `apps/web-app/src/utils/__tests__/formValidators.test.ts`
- Component tests: `apps/web-app/src/components/form-runtime/__tests__/ValidationError.test.tsx`

**Testing Frameworks:**
- Frontend: Vitest + React Testing Library [Source: docs/architecture/tech-stack.md]

**Testing Patterns:**
- Unit tests for validation functions
- Component tests for error display
- Integration tests for form validation flow
- Test all validation rules (required, pattern, min/max, email, URL)
- Test async validation
- Test validation state persistence

**Test Coverage Target:** >80% for business logic [Source: docs/architecture.md#testing-strategy]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent - will list all files created/modified during implementation_

## QA Results

_This section will be populated by the QA Agent after review_


# Story 1.4: Basic Form Data Storage

## Status

InProgress

## Story

**As a** form user,
**I want** to save form submission data,
**so that** I can complete forms and retrieve my submissions later.

## Acceptance Criteria

1. Database schema for form submissions (id, form_id, data, submitted_by, submitted_at, status)
2. REST API endpoint to save form submission (POST /api/submissions)
3. REST API endpoint to retrieve user's submissions (GET /api/submissions?form_id={id})
4. REST API endpoint to retrieve a specific submission (GET /api/submissions/{id})
5. REST API endpoint to update submission (PUT /api/submissions/{id}) for autosave functionality
6. Authorization checks: users can only access their own submissions (unless admin)
7. Input validation: form_id must exist, data must match form schema structure
8. Soft delete functionality for submissions
9. Audit logging for submission operations
10. Unit tests for submission service layer with >80% coverage

## Tasks / Subtasks

- [ ] Task 1: Create Form Runtime Service Project Structure (AC: 1, 2)
  - [ ] Create apps/form-runtime-service/ directory structure
  - [ ] Initialize .NET 8 ASP.NET Core Web API project
  - [ ] Set up project file with required dependencies
  - [ ] Configure Program.cs with minimal API setup
  - [ ] Create Controllers/, Services/, Repositories/, Models/ directories
  - [ ] Set up dependency injection container

- [ ] Task 2: Create Form Submission Database Schema (AC: 1)
  - [ ] Create FormSubmission entity model with all required properties
  - [ ] Configure Entity Framework Core DbContext
  - [ ] Set up PostgreSQL connection string
  - [ ] Create database migration for submissions table
  - [ ] Configure JSON column type for data field
  - [ ] Add indexes for performance (form_id, submitted_by, status, tenant_id)

- [ ] Task 3: Implement Form Submission Repository Layer (AC: 1, 8)
  - [ ] Create IFormSubmissionRepository interface
  - [ ] Implement FormSubmissionRepository with CRUD operations
  - [ ] Implement soft delete (set DeletedAt timestamp)
  - [ ] Add methods for filtering by form_id, user_id, status
  - [ ] Add method to get user's submissions
  - [ ] Implement query optimization for list operations

- [ ] Task 4: Implement Form Submission Service Layer (AC: 1, 5, 6, 7)
  - [ ] Create IFormSubmissionService interface
  - [ ] Implement FormSubmissionService with business logic
  - [ ] Add authorization checks (user can only access own submissions unless admin)
  - [ ] Implement input validation (form_id exists, data matches schema)
  - [ ] Implement autosave functionality (update existing draft)
  - [ ] Implement soft delete logic
  - [ ] Add tenant isolation checks
  - [ ] Handle submission status management (draft, submitted, approved, rejected, completed)

- [ ] Task 5: Implement Form Submission Controller with Endpoints (AC: 2, 3, 4, 5)
  - [ ] Create FormSubmissionsController with [ApiController] and [Route] attributes
  - [ ] Implement POST /api/submissions - Create/save submission endpoint
  - [ ] Implement GET /api/submissions/{id} - Get submission by ID endpoint
  - [ ] Implement GET /api/submissions - List user's submissions with filtering
  - [ ] Implement PUT /api/submissions/{id} - Update submission (autosave) endpoint
  - [ ] Implement DELETE /api/submissions/{id} - Soft delete submission endpoint
  - [ ] Add proper HTTP status codes
  - [ ] Add request/response DTOs for all endpoints

- [ ] Task 6: Implement Form Schema Validation (AC: 7)
  - [ ] Create FormSchemaValidator service
  - [ ] Validate submission data against form schema
  - [ ] Check required fields
  - [ ] Validate field types
  - [ ] Return validation errors with field-level details
  - [ ] Integrate with Form Builder Service to fetch form schema

- [ ] Task 7: Implement Authorization Checks (AC: 6)
  - [ ] Add [Authorize] attribute to all submission endpoints
  - [ ] Create authorization check in FormSubmissionService
  - [ ] Extract user ID from JWT token claims
  - [ ] Check user roles (Admin can access any submission)
  - [ ] Return 403 Forbidden for unauthorized access attempts
  - [ ] Enforce tenant isolation

- [ ] Task 8: Implement Autosave Functionality (AC: 5)
  - [ ] Detect if submission already exists (draft status)
  - [ ] Update existing draft instead of creating new
  - [ ] Set last saved timestamp
  - [ ] Handle concurrent autosave requests
  - [ ] Optimize autosave performance

- [ ] Task 9: Implement Audit Logging (AC: 9)
  - [ ] Reuse AuditLog entity from Form Builder Service (or create shared)
  - [ ] Log submission creation (who, what, when)
  - [ ] Log submission updates (who, what, when, what changed)
  - [ ] Log submission deletions (who, what, when)
  - [ ] Log submission status changes
  - [ ] Store audit logs in database

- [ ] Task 10: Write Unit Tests (AC: 10)
  - [ ] Create unit test project
  - [ ] Write unit tests for FormSubmissionService (>80% coverage)
  - [ ] Write unit tests for FormSubmissionRepository
  - [ ] Mock dependencies (repositories, form service)
  - [ ] Test CRUD operations
  - [ ] Test authorization checks
  - [ ] Test input validation
  - [ ] Test autosave functionality
  - [ ] Test soft delete functionality
  - [ ] Achieve >80% code coverage

## Dev Notes

### Previous Story Insights

From Story 1.3:
- Form Builder Service is implemented and available
- Form entities are stored in PostgreSQL with JSON Schema
- Authorization middleware is configured
- Audit logging infrastructure exists
- User ID and tenant ID can be extracted from JWT claims

### Data Models

**FormSubmission Model:**
```typescript
interface FormSubmission {
  id: string;                    // UUID
  formId: string;                // UUID - Reference to form definition
  formVersion: string;            // Form version used for submission
  data: Record<string, any>;      // Submitted form data (stored as JSONB)
  status: 'draft' | 'submitted' | 'approved' | 'rejected' | 'completed';
  submittedBy: string;            // UUID - User ID of submitter
  submittedAt?: Date;             // Submission timestamp (null for drafts)
  tenantId: string;               // UUID - Multi-tenant isolation
  workflowInstanceId?: string;    // Workflow instance ID (if workflow enabled)
  deletedAt?: Date;               // Soft delete timestamp
  createdAt: Date;
  updatedAt: Date;
}
```

[Source: docs/architecture.md#data-models]

### API Specifications

**Form Submission Endpoints:**

- `POST /api/submissions` - Create/save form submission
  - Request Body: `{ "formId": "uuid", "data": {...}, "status": "draft" }`
  - Response: `{ "id": "uuid", "formId": "uuid", "data": {...}, "status": "draft", ... }` (201 Created)
  - Authorization: Authenticated users
  - Validation: formId must exist, data must match form schema

- `GET /api/submissions/{id}` - Get submission by ID
  - Response: `{ "id": "uuid", "formId": "uuid", "data": {...}, ... }` (200 OK)
  - Authorization: Owner or Admin only
  - Returns 404 if submission not found or soft deleted

- `GET /api/submissions` - List user's submissions
  - Query Parameters: `formId`, `status`, `page`, `pageSize`
  - Response: `{ "items": [...], "totalCount": number, "page": number, ... }`
  - Authorization: Authenticated users (returns only own submissions)
  - Supports filtering by formId and status

- `PUT /api/submissions/{id}` - Update submission (autosave)
  - Request Body: `{ "data": {...}, "status": "draft" }`
  - Response: `{ "id": "uuid", ... }` (200 OK)
  - Authorization: Owner only
  - Updates existing draft submission

- `DELETE /api/submissions/{id}` - Soft delete submission
  - Response: `{ "success": true }` (200 OK)
  - Authorization: Owner or Admin only
  - Sets deletedAt timestamp (soft delete)

[Source: docs/architecture.md#components - Form Runtime Service]

### File Locations

**Backend Service Structure:**
```
apps/form-runtime-service/
├── src/
│   ├── Controllers/
│   │   └── FormSubmissionsController.cs    # Submission endpoints
│   ├── Services/
│   │   ├── FormSubmissionService.cs       # Submission business logic
│   │   └── FormSchemaValidator.cs         # Schema validation service
│   ├── Repositories/
│   │   ├── IFormSubmissionRepository.cs
│   │   └── FormSubmissionRepository.cs
│   ├── Models/
│   │   ├── FormSubmission.cs              # Submission entity
│   │   └── DTOs/                           # Data transfer objects
│   │       ├── CreateSubmissionRequest.cs
│   │       ├── UpdateSubmissionRequest.cs
│   │       ├── SubmissionResponse.cs
│   │       └── SubmissionFilterRequest.cs
│   ├── Data/
│   │   └── FormRuntimeDbContext.cs        # Database context
│   └── Program.cs                          # Application entry point
├── tests/
│   ├── Unit/
│   │   └── Services/
│   └── Integration/
│       └── Controllers/
└── FormRuntimeService.csproj
```

[Source: docs/architecture/source-tree.md]

### Testing Requirements

**Test File Location:**
- Backend unit tests: `apps/form-runtime-service/tests/Unit/Services/`, `apps/form-runtime-service/tests/Unit/Repositories/`
- Backend integration tests: `apps/form-runtime-service/tests/Integration/Controllers/`

**Testing Frameworks:**
- Backend: xUnit + Moq [Source: docs/architecture/tech-stack.md]

**Testing Patterns:**
- Unit tests for FormSubmissionService (mock dependencies)
- Unit tests for FormSubmissionRepository
- Integration tests for FormSubmissionsController
- Test authorization checks (owner can access, others cannot)
- Test input validation (formId exists, data matches schema)
- Test autosave functionality
- Test soft delete functionality
- Test tenant isolation

**Test Coverage Target:** >80% for business logic [Source: docs/architecture.md#testing-strategy]

### Technical Constraints

**Technology Stack:**
- Backend Framework: ASP.NET Core 8.0 [Source: docs/architecture/tech-stack.md]
- Database: PostgreSQL 15+ with Entity Framework Core [Source: docs/architecture/tech-stack.md]
- Validation: FluentValidation [Source: docs/architecture.md#components - Form Runtime Service]

**Database Schema:**
```sql
-- Form submissions table
CREATE TABLE form_submissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    form_id UUID NOT NULL REFERENCES forms(id) ON DELETE RESTRICT,
    form_version VARCHAR(50) NOT NULL,
    data JSONB NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'approved', 'rejected', 'completed')),
    submitted_by UUID NOT NULL REFERENCES users(id) ON DELETE RESTRICT,
    submitted_at TIMESTAMP WITH TIME ZONE,
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    workflow_instance_id VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    deleted_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_submissions_form_id ON form_submissions(form_id);
CREATE INDEX idx_submissions_submitted_by ON form_submissions(submitted_by);
CREATE INDEX idx_submissions_status ON form_submissions(status);
CREATE INDEX idx_submissions_tenant_id ON form_submissions(tenant_id);
CREATE INDEX idx_submissions_deleted_at ON form_submissions(deleted_at) WHERE deleted_at IS NULL;
```

[Source: docs/architecture.md#database-schema]

**Authorization Rules:**
- All endpoints require authentication ([Authorize] attribute)
- Users can only access their own submissions (submittedBy == userId)
- Admin role can access any submission
- Tenant isolation: Users can only access submissions in their tenant

**Form Schema Validation:**
- Fetch form schema from Form Builder Service
- Validate submission data against JSON Schema
- Check required fields
- Validate field types and constraints
- Return detailed validation errors

**Environment Variables Required:**
- `ConnectionStrings__DefaultConnection` - PostgreSQL connection string
- `JWT__Issuer` - JWT issuer (for token validation)
- `JWT__Audience` - JWT audience (for token validation)
- `FormBuilderService__BaseUrl` - Form Builder Service URL (for fetching form schemas)

[Source: docs/architecture.md#development-workflow]

## Testing

### Testing Standards

**Test File Location:**
- Backend unit tests: `apps/form-runtime-service/tests/Unit/Services/`, `apps/form-runtime-service/tests/Unit/Repositories/`
- Backend integration tests: `apps/form-runtime-service/tests/Integration/Controllers/`

**Testing Frameworks:**
- Backend: xUnit + Moq [Source: docs/architecture/tech-stack.md]

**Testing Patterns:**
- Unit tests for FormSubmissionService (mock dependencies)
- Unit tests for FormSubmissionRepository
- Integration tests for FormSubmissionsController
- Test authorization checks with different user roles
- Test input validation with invalid data
- Test autosave functionality
- Test soft delete functionality
- Test tenant isolation

**Test Coverage Target:** >80% for business logic [Source: docs/architecture.md#testing-strategy]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-12 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent - will list all files created/modified during implementation_

## QA Results

_This section will be populated by the QA Agent after review_


# Story 1.7: Health Checks and Monitoring

## Status

Draft

## Story

**As a** system administrator,
**I want** health check endpoints and monitoring capabilities,
**so that** I can monitor service health and diagnose issues.

## Acceptance Criteria

1. Health check endpoint implemented for all services (/health)
2. Health check includes database connectivity check
3. Health check includes external service dependency checks (if applicable)
4. Health check returns detailed status (healthy, degraded, unhealthy)
5. Readiness probe endpoint (/health/ready) for Kubernetes
6. Liveness probe endpoint (/health/live) for Kubernetes
7. Structured logging with correlation IDs
8. Log aggregation configuration (Serilog or similar)
9. Basic metrics endpoint (/metrics) for Prometheus
10. Health check dashboard or status page (optional)

## Tasks / Subtasks

- [ ] Task 1: Implement Health Check Endpoints (AC: 1)
  - [ ] Add health check middleware to Auth Service
  - [ ] Add health check middleware to Form Builder Service
  - [ ] Add health check middleware to Form Runtime Service
  - [ ] Create /health endpoint returning service status
  - [ ] Return JSON response with status and timestamp

- [ ] Task 2: Implement Database Connectivity Check (AC: 2)
  - [ ] Check PostgreSQL connection in health check
  - [ ] Return degraded status if database unavailable
  - [ ] Include database response time in health check
  - [ ] Handle connection timeout gracefully

- [ ] Task 3: Implement External Service Dependency Checks (AC: 3)
  - [ ] Check Form Builder Service connectivity (from Form Runtime Service)
  - [ ] Check Auth Service connectivity (from other services)
  - [ ] Return degraded status if dependencies unavailable
  - [ ] Include dependency status in health check response

- [ ] Task 4: Implement Detailed Health Status (AC: 4)
  - [ ] Define health status enum (Healthy, Degraded, Unhealthy)
  - [ ] Return overall service status
  - [ ] Return individual component statuses
  - [ ] Include error messages for failed checks

- [ ] Task 5: Implement Readiness Probe (AC: 5)
  - [ ] Create /health/ready endpoint
  - [ ] Check if service is ready to accept traffic
  - [ ] Verify database connectivity
  - [ ] Return 200 OK if ready, 503 if not ready
  - [ ] Configure Kubernetes readiness probe

- [ ] Task 6: Implement Liveness Probe (AC: 6)
  - [ ] Create /health/live endpoint
  - [ ] Check if service is alive (basic check)
  - [ ] Return 200 OK if alive, 503 if dead
  - [ ] Configure Kubernetes liveness probe

- [ ] Task 7: Implement Structured Logging (AC: 7)
  - [ ] Configure Serilog or similar logging framework
  - [ ] Add correlation ID middleware
  - [ ] Generate correlation ID for each request
  - [ ] Include correlation ID in all log entries
  - [ ] Configure log levels per environment

- [ ] Task 8: Configure Log Aggregation (AC: 8)
  - [ ] Set up Serilog sinks (Console, File, Seq, or similar)
  - [ ] Configure structured JSON logging
  - [ ] Set up log rotation
  - [ ] Configure log retention policy
  - [ ] Document log aggregation setup

- [ ] Task 9: Implement Metrics Endpoint (AC: 9)
  - [ ] Add Prometheus metrics library
  - [ ] Create /metrics endpoint
  - [ ] Expose basic metrics (request count, response time, error rate)
  - [ ] Configure Prometheus scraping
  - [ ] Document metrics available

- [ ] Task 10: Create Health Check Dashboard (AC: 10, Optional)
  - [ ] Create simple status page showing all services
  - [ ] Display health status for each service
  - [ ] Show last check timestamp
  - [ ] Add refresh functionality
  - [ ] Style with simple HTML/CSS

## Dev Notes

### Previous Story Insights

From Stories 1.1, 1.2, 1.3, 1.4:
- All services are implemented with .NET 8
- Database connections are configured
- Services have dependencies on each other
- Logging infrastructure needs to be standardized

### API Specifications

**Health Check Endpoints:**
- `GET /health` - Overall health check
  - Response: `{ "status": "Healthy|Degraded|Unhealthy", "timestamp": "2025-01-12T10:00:00Z", "checks": {...} }`
  
- `GET /health/ready` - Readiness probe
  - Response: 200 OK if ready, 503 Service Unavailable if not ready
  
- `GET /health/live` - Liveness probe
  - Response: 200 OK if alive, 503 Service Unavailable if dead

- `GET /metrics` - Prometheus metrics
  - Response: Prometheus text format

[Source: docs/architecture.md#components]

### File Locations

**Health Check Implementation:**
```
apps/{service-name}/src/
├── Middleware/
│   ├── HealthCheckMiddleware.cs
│   └── CorrelationIdMiddleware.cs
├── Services/
│   └── HealthCheckService.cs
└── Program.cs                    # Configure health checks
```

[Source: docs/architecture/source-tree.md]

### Technical Constraints

**Technology Stack:**
- .NET 8 Health Checks middleware [Source: docs/architecture/tech-stack.md]
- Serilog for structured logging [Source: docs/architecture/tech-stack.md]
- Prometheus.NET for metrics [Source: docs/architecture/tech-stack.md]

**Health Check Configuration:**
- Use ASP.NET Core Health Checks middleware
- Configure health check services in Program.cs
- Set up health check UI (optional) for development

**Logging Configuration:**
- Structured JSON logging
- Correlation ID in all log entries
- Log levels: Debug (Development), Information (Production)
- Log sinks: Console, File, Seq (or similar)

**Metrics Configuration:**
- Prometheus metrics format
- Basic metrics: HTTP request count, response time, error rate
- Custom metrics for business logic (optional)

**Environment Variables Required:**
- `Logging__LogLevel__Default` - Default log level
- `HealthChecks__Enabled` - Enable/disable health checks

[Source: docs/architecture.md#development-workflow]

## Testing

### Testing Standards

**Test File Location:**
- Backend integration tests: `apps/{service-name}/tests/Integration/HealthChecks/`

**Testing Frameworks:**
- Backend: xUnit + Microsoft.AspNetCore.Mvc.Testing [Source: docs/architecture/tech-stack.md]

**Testing Patterns:**
- Integration tests for health check endpoints
- Test health check with database available/unavailable
- Test health check with dependencies available/unavailable
- Test readiness and liveness probes
- Test correlation ID generation and logging

**Test Coverage Target:** >80% for health check logic [Source: docs/architecture.md#testing-strategy]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent - will list all files created/modified during implementation_

## QA Results

_This section will be populated by the QA Agent after review_


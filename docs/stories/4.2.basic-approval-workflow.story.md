# Story 4.2: Basic Approval Workflow

## Status

Draft

## Story

**As a** form user,
**I want** my form submission to trigger an approval workflow,
**so that** the form can be reviewed and approved by authorized users.

## Acceptance Criteria

1. Form builder can enable "Requires Approval" option for forms
2. Approval workflow definition (BPMN) created for form approvals
3. Workflow triggered automatically when form is submitted
4. Approval task assigned to specified user or role
5. Approval notification sent to approver (email/in-app)
6. Approver can view form submission in approval interface
7. Approver can approve or reject submission with comments
8. Approval decision updates form submission status
9. Original submitter notified of approval/rejection decision
10. Approval history tracked in audit trail

## Tasks / Subtasks

- [ ] Task 1: Add Approval Configuration to Form Builder (AC: 1)
  - [ ] Add "Requires Approval" checkbox to form metadata
  - [ ] Add approver selection (user or role)
  - [ ] Save approval configuration in form definition
  - [ ] Update form schema to include approval config

- [ ] Task 2: Create Approval Workflow Definition (AC: 2)
  - [ ] Create BPMN workflow definition for approvals
  - [ ] Define approval task node
  - [ ] Define approval/rejection paths
  - [ ] Deploy workflow definition to workflow engine
  - [ ] Test workflow definition

- [ ] Task 3: Implement Automatic Workflow Trigger (AC: 3)
  - [ ] Detect form submission with approval required
  - [ ] Create workflow instance when form submitted
  - [ ] Pass form submission data to workflow
  - [ ] Link workflow instance to form submission
  - [ ] Handle workflow creation errors

- [ ] Task 4: Implement Task Assignment (AC: 4)
  - [ ] Assign approval task to specified user
  - [ ] Assign approval task to role (all users in role)
  - [ ] Handle user not found errors
  - [ ] Handle role assignment logic
  - [ ] Support multiple approvers (parallel or sequential)

- [ ] Task 5: Implement Approval Notifications (AC: 5)
  - [ ] Send email notification to approver
  - [ ] Create in-app notification
  - [ ] Include form submission link in notification
  - [ ] Include form name and submitter info
  - [ ] Handle notification failures

- [ ] Task 6: Create Approval Interface (AC: 6)
  - [ ] Create approval page/route
  - [ ] Display form submission data
  - [ ] Display form schema and values
  - [ ] Show submission metadata
  - [ ] Style approval interface consistently

- [ ] Task 7: Implement Approval/Rejection Actions (AC: 7)
  - [ ] Add "Approve" button
  - [ ] Add "Reject" button
  - [ ] Add comments textarea
  - [ ] Complete workflow task on approval/rejection
  - [ ] Pass comments to workflow
  - [ ] Update workflow variables

- [ ] Task 8: Update Form Submission Status (AC: 8)
  - [ ] Update submission status on approval
  - [ ] Update submission status on rejection
  - [ ] Store approval decision in submission
  - [ ] Store approver and timestamp
  - [ ] Handle status update errors

- [ ] Task 9: Implement Submitter Notification (AC: 9)
  - [ ] Send email notification to submitter
  - [ ] Create in-app notification
  - [ ] Include approval/rejection decision
  - [ ] Include approver comments
  - [ ] Include link to view submission

- [ ] Task 10: Implement Approval History Tracking (AC: 10)
  - [ ] Log approval actions to audit trail
  - [ ] Store approval history in database
  - [ ] Display approval history in UI
  - [ ] Include approver, decision, comments, timestamp
  - [ ] Support multiple approval stages

## Dev Notes

### Previous Story Insights

From Story 4.1:
- Workflow engine is deployed and configured
- Workflow service is implemented
- Workflow instance creation is working

From Story 1.4:
- Form Runtime Service handles form submissions
- Submission status tracking is implemented

### Data Models

**Approval Configuration:**
```typescript
interface ApprovalConfig {
  requiresApproval: boolean;
  approverType: 'user' | 'role';
  approverId?: string;
  approverRole?: string;
  approvalWorkflowId?: string;
}
```

**Approval History:**
```typescript
interface ApprovalHistory {
  id: string;
  submissionId: string;
  approverId: string;
  decision: 'approved' | 'rejected';
  comments?: string;
  timestamp: Date;
}
```

[Source: docs/architecture.md#data-models]

### API Specifications

**Approval Endpoints:**
- `GET /api/workflows/tasks` - List user's approval tasks
- `POST /api/workflows/tasks/{id}/approve` - Approve submission
- `POST /api/workflows/tasks/{id}/reject` - Reject submission
- `GET /api/submissions/{id}/approval-history` - Get approval history

[Source: docs/architecture.md#components - Workflow Service]

### File Locations

**Approval Implementation:**
```
apps/web-app/src/
├── pages/
│   └── Approvals/
│       ├── ApprovalsListPage.tsx
│       └── ApprovalDetailPage.tsx
apps/workflow-service/src/
├── Controllers/
│   └── ApprovalController.cs
└── Services/
    └── ApprovalService.cs
```

[Source: docs/architecture/source-tree.md]

### Technical Constraints

**Technology Stack:**
- Backend: ASP.NET Core 8.0 [Source: docs/architecture/tech-stack.md]
- Workflow Engine: Camunda 8 or Temporal [Source: docs/architecture/tech-stack.md]
- Frontend: React 18+ with TypeScript [Source: docs/architecture/tech-stack.md]

**Workflow Definition:**
- BPMN 2.0 format (if using Camunda)
- Code-based workflow (if using Temporal)
- Simple approval workflow: Submit → Approve/Reject → Complete

**Environment Variables Required:**
- `EmailService__SmtpServer` - SMTP server for email notifications
- `EmailService__FromAddress` - From email address

[Source: docs/architecture.md#development-workflow]

## Testing

### Testing Standards

**Test File Location:**
- Backend unit tests: `apps/workflow-service/tests/Unit/Services/`
- Backend integration tests: `apps/workflow-service/tests/Integration/`
- Frontend component tests: `apps/web-app/src/pages/Approvals/__tests__/`

**Testing Frameworks:**
- Backend: xUnit + Moq [Source: docs/architecture/tech-stack.md]
- Frontend: Vitest + React Testing Library [Source: docs/architecture/tech-stack.md]

**Testing Patterns:**
- Unit tests for approval service logic
- Integration tests for workflow approval flow
- Component tests for approval UI
- Test approval/rejection actions
- Test notification sending
- Test approval history tracking

**Test Coverage Target:** >80% for business logic [Source: docs/architecture.md#testing-strategy]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent - will list all files created/modified during implementation_

## QA Results

_This section will be populated by the QA Agent after review_


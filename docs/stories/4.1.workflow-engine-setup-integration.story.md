# Story 4.1: Workflow Engine Setup and Integration

## Status

Draft

## Story

**As a** system administrator,
**I want** workflow engine infrastructure configured,
**so that** forms can trigger business processes.

## Acceptance Criteria

1. Camunda 8 (Zeebe) or Temporal workflow engine deployed and configured
2. Workflow service implemented (.NET 8) to interact with workflow engine
3. Workflow engine connection configuration (connection strings, credentials)
4. Health check endpoint for workflow engine connectivity
5. Basic workflow definition deployment mechanism
6. Workflow instance creation API endpoint
7. Workflow instance status query API endpoint
8. Error handling for workflow engine failures
9. Logging integration: workflow events logged to application logs
10. Documentation: workflow engine setup and configuration guide

## Tasks / Subtasks

- [ ] Task 1: Choose and Deploy Workflow Engine (AC: 1)
  - [ ] Evaluate Camunda 8 vs Temporal
  - [ ] Make decision on workflow engine
  - [ ] Deploy workflow engine (Docker/Kubernetes)
  - [ ] Configure workflow engine settings
  - [ ] Test workflow engine connectivity

- [ ] Task 2: Create Workflow Service Project (AC: 2)
  - [ ] Create apps/workflow-service/ directory structure
  - [ ] Initialize .NET 8 ASP.NET Core Web API project
  - [ ] Set up project file with required dependencies
  - [ ] Install workflow engine client SDK
  - [ ] Configure Program.cs with minimal API setup

- [ ] Task 3: Configure Workflow Engine Connection (AC: 3)
  - [ ] Add connection string configuration
  - [ ] Add credentials configuration
  - [ ] Create workflow engine client factory
  - [ ] Implement connection retry logic
  - [ ] Handle connection failures gracefully

- [ ] Task 4: Implement Health Check Endpoint (AC: 4)
  - [ ] Create /health endpoint
  - [ ] Check workflow engine connectivity
  - [ ] Return health status (healthy, degraded, unhealthy)
  - [ ] Include workflow engine status in health check
  - [ ] Add to Kubernetes readiness/liveness probes

- [ ] Task 5: Implement Workflow Definition Deployment (AC: 5)
  - [ ] Create workflow definition model (BPMN or code-based)
  - [ ] Implement deployment API endpoint
  - [ ] Deploy workflow definitions to engine
  - [ ] Handle deployment errors
  - [ ] Support workflow definition versioning

- [ ] Task 6: Implement Workflow Instance Creation (AC: 6)
  - [ ] Create workflow instance API endpoint
  - [ ] Map form submission to workflow variables
  - [ ] Start workflow instance in engine
  - [ ] Return workflow instance ID
  - [ ] Handle workflow creation errors

- [ ] Task 7: Implement Workflow Instance Status Query (AC: 7)
  - [ ] Create workflow status API endpoint
  - [ ] Query workflow instance status from engine
  - [ ] Return workflow state and variables
  - [ ] Return current task assignments
  - [ ] Handle workflow not found errors

- [ ] Task 8: Implement Error Handling (AC: 8)
  - [ ] Handle workflow engine connection failures
  - [ ] Handle workflow deployment failures
  - [ ] Handle workflow instance creation failures
  - [ ] Handle workflow query failures
  - [ ] Return appropriate HTTP status codes
  - [ ] Log all errors with context

- [ ] Task 9: Implement Logging Integration (AC: 9)
  - [ ] Log workflow events to application logs
  - [ ] Include correlation IDs in logs
  - [ ] Log workflow instance creation
  - [ ] Log workflow state changes
  - [ ] Log workflow task assignments
  - [ ] Use structured logging format

- [ ] Task 10: Create Documentation (AC: 10)
  - [ ] Document workflow engine setup
  - [ ] Document configuration options
  - [ ] Document API endpoints
  - [ ] Document error handling
  - [ ] Create workflow definition examples
  - [ ] Document deployment process

## Dev Notes

### Previous Story Insights

From Story 1.4:
- Form Runtime Service is implemented
- Form submissions can be created and updated
- Submission status tracking is in place

### Data Models

**Workflow Instance Model:**
```typescript
interface WorkflowInstance {
  id: string;
  workflowDefinitionId: string;
  workflowDefinitionVersion: number;
  status: 'running' | 'completed' | 'failed' | 'cancelled';
  variables: Record<string, any>;
  currentTasks: WorkflowTask[];
  startedAt: Date;
  completedAt?: Date;
}

interface WorkflowTask {
  id: string;
  name: string;
  assignee?: string;
  candidateUsers?: string[];
  candidateGroups?: string[];
  dueDate?: Date;
}
```

[Source: docs/architecture.md#components - Workflow Service]

### API Specifications

**Workflow Service Endpoints:**
- `POST /api/workflows/deploy` - Deploy workflow definition
- `POST /api/workflows/instances` - Create workflow instance
- `GET /api/workflows/instances/{id}` - Get workflow instance status
- `POST /api/workflows/instances/{id}/complete-task` - Complete workflow task
- `GET /api/workflows/tasks` - List user's workflow tasks

[Source: docs/architecture.md#components - Workflow Service]

### File Locations

**Backend Service Structure:**
```
apps/workflow-service/
├── src/
│   ├── Controllers/
│   │   └── WorkflowsController.cs
│   ├── Services/
│   │   ├── IWorkflowService.cs
│   │   └── WorkflowService.cs
│   ├── Models/
│   │   ├── WorkflowInstance.cs
│   │   └── WorkflowTask.cs
│   └── Program.cs
└── workflows/
    └── approval-workflow.bpmn    # BPMN workflow definitions
```

[Source: docs/architecture/source-tree.md]

### Technical Constraints

**Technology Stack:**
- Backend Framework: ASP.NET Core 8.0 [Source: docs/architecture/tech-stack.md]
- Workflow Engine: Camunda 8 (Zeebe) or Temporal [Source: docs/architecture/tech-stack.md]
- Workflow Client: Camunda Zeebe Client or Temporal .NET SDK

**Workflow Engine Decision:**
- Camunda 8: BPMN-based, mature, good .NET support
- Temporal: Code-based, more flexible, newer
- Decision needed: Choose based on team expertise and requirements

**Environment Variables Required:**
- `WorkflowEngine__Type` - "Camunda" or "Temporal"
- `WorkflowEngine__ConnectionString` - Workflow engine connection string
- `WorkflowEngine__Credentials` - Authentication credentials

[Source: docs/architecture.md#development-workflow]

## Testing

### Testing Standards

**Test File Location:**
- Backend unit tests: `apps/workflow-service/tests/Unit/Services/`
- Backend integration tests: `apps/workflow-service/tests/Integration/`

**Testing Frameworks:**
- Backend: xUnit + Moq [Source: docs/architecture/tech-stack.md]

**Testing Patterns:**
- Unit tests for WorkflowService (mock workflow engine client)
- Integration tests for workflow engine connectivity
- Test workflow instance creation
- Test workflow status queries
- Test error handling scenarios

**Test Coverage Target:** >80% for business logic [Source: docs/architecture.md#testing-strategy]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent - will list all files created/modified during implementation_

## QA Results

_This section will be populated by the QA Agent after review_


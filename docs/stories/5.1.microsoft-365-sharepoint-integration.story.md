# Story 5.1: Microsoft 365 and SharePoint Integration

## Status

Draft

## Story

**As a** system administrator,
**I want** to integrate with Microsoft 365 and SharePoint,
**so that** forms can be stored in SharePoint and synced with OneDrive.

## Acceptance Criteria

1. Microsoft Graph API integration configured (OAuth2 with Azure AD)
2. SharePoint site connection: configure target SharePoint site/library
3. Form submissions can be saved to SharePoint as documents
4. Form templates can be stored in SharePoint document library
5. OneDrive integration: form drafts synced to user's OneDrive
6. SharePoint metadata mapping: form fields mapped to SharePoint columns
7. SharePoint versioning: form submissions create new versions in SharePoint
8. SharePoint permissions: respect SharePoint permissions for form access
9. Error handling: handle SharePoint API errors gracefully
10. Configuration UI: admin interface for SharePoint connection settings

## Tasks / Subtasks

- [ ] Task 1: Configure Microsoft Graph API Integration (AC: 1)
  - [ ] Register application in Azure AD
  - [ ] Configure OAuth2 permissions (Sites.ReadWrite.All, Files.ReadWrite.All)
  - [ ] Implement Microsoft Graph client
  - [ ] Handle token acquisition and refresh
  - [ ] Test Graph API connectivity

- [ ] Task 2: Implement SharePoint Site Connection (AC: 2)
  - [ ] Create SharePoint connection configuration model
  - [ ] Store SharePoint site URL and library name
  - [ ] Validate SharePoint connection
  - [ ] Test SharePoint site access
  - [ ] Handle connection errors

- [ ] Task 3: Implement Form Submission to SharePoint (AC: 3)
  - [ ] Create service to save submissions to SharePoint
  - [ ] Convert form submission to document format
  - [ ] Upload document to SharePoint library
  - [ ] Set document metadata
  - [ ] Handle upload errors

- [ ] Task 4: Implement Form Template Storage (AC: 4)
  - [ ] Save form templates to SharePoint
  - [ ] Retrieve form templates from SharePoint
  - [ ] Sync form templates between systems
  - [ ] Handle template versioning
  - [ ] Handle template access permissions

- [ ] Task 5: Implement OneDrive Integration (AC: 5)
  - [ ] Create OneDrive sync service
  - [ ] Sync form drafts to user's OneDrive
  - [ ] Retrieve drafts from OneDrive
  - [ ] Handle OneDrive sync conflicts
  - [ ] Handle OneDrive API errors

- [ ] Task 6: Implement SharePoint Metadata Mapping (AC: 6)
  - [ ] Map form fields to SharePoint columns
  - [ ] Create SharePoint columns if needed
  - [ ] Update SharePoint metadata on submission
  - [ ] Handle metadata mapping errors
  - [ ] Support custom metadata mappings

- [ ] Task 7: Implement SharePoint Versioning (AC: 7)
  - [ ] Create new version on form submission
  - [ ] Track version history
  - [ ] Retrieve previous versions
  - [ ] Handle version conflicts
  - [ ] Respect SharePoint versioning settings

- [ ] Task 8: Implement SharePoint Permissions (AC: 8)
  - [ ] Check SharePoint permissions before access
  - [ ] Respect SharePoint access control
  - [ ] Handle permission denied errors
  - [ ] Map form permissions to SharePoint permissions
  - [ ] Support SharePoint permission inheritance

- [ ] Task 9: Implement Error Handling (AC: 9)
  - [ ] Handle SharePoint API errors
  - [ ] Handle network errors
  - [ ] Handle authentication errors
  - [ ] Retry failed operations
  - [ ] Log errors with context
  - [ ] Show user-friendly error messages

- [ ] Task 10: Create Configuration UI (AC: 10)
  - [ ] Create admin interface for SharePoint settings
  - [ ] Add SharePoint connection form
  - [ ] Test connection button
  - [ ] Display connection status
  - [ ] Allow editing connection settings
  - [ ] Secure credential storage

## Dev Notes

### Previous Story Insights

From Story 1.2:
- Azure AD integration is implemented
- OAuth2/OIDC authentication is working
- User authentication with Azure AD is configured

From Story 1.3:
- Form Builder Service stores form definitions
- Form schemas are available

From Story 1.4:
- Form Runtime Service handles form submissions
- Submission data is stored

### Data Models

**SharePoint Integration Configuration:**
```typescript
interface SharePointConfig {
  siteUrl: string;
  libraryName: string;
  tenantId: string;
  clientId: string;
  metadataMappings: Record<string, string>; // form field -> SharePoint column
}
```

[Source: docs/architecture.md#components - Integration Service]

### API Specifications

**SharePoint Integration Endpoints:**
- `POST /api/integrations/sharepoint/configure` - Configure SharePoint connection
- `POST /api/integrations/sharepoint/test-connection` - Test SharePoint connection
- `POST /api/integrations/sharepoint/save-submission` - Save submission to SharePoint
- `GET /api/integrations/sharepoint/submissions/{id}` - Get submission from SharePoint

[Source: docs/architecture.md#components - Integration Service]

### File Locations

**SharePoint Integration Implementation:**
```
apps/integration-service/src/
├── Services/
│   ├── ISharePointService.cs
│   └── SharePointService.cs
├── Services/
│   ├── IMicrosoftGraphService.cs
│   └── MicrosoftGraphService.cs
└── Controllers/
    └── SharePointIntegrationController.cs
```

[Source: docs/architecture/source-tree.md]

### Technical Constraints

**Technology Stack:**
- Backend: ASP.NET Core 8.0 [Source: docs/architecture/tech-stack.md]
- Microsoft Graph SDK: Microsoft.Graph [Source: docs/architecture/tech-stack.md]
- Authentication: Microsoft.Identity.Web [Source: docs/architecture/tech-stack.md]

**Microsoft Graph Permissions Required:**
- `Sites.ReadWrite.All` - Read and write SharePoint sites
- `Files.ReadWrite.All` - Read and write files in OneDrive
- `User.Read` - Read user profile

**Environment Variables Required:**
- `AzureAd__TenantId` - Azure AD tenant ID
- `AzureAd__ClientId` - Azure AD client ID
- `AzureAd__ClientSecret` - Azure AD client secret
- `SharePoint__DefaultSiteUrl` - Default SharePoint site URL

[Source: docs/architecture.md#development-workflow]

## Testing

### Testing Standards

**Test File Location:**
- Backend unit tests: `apps/integration-service/tests/Unit/Services/`
- Backend integration tests: `apps/integration-service/tests/Integration/`

**Testing Frameworks:**
- Backend: xUnit + Moq [Source: docs/architecture/tech-stack.md]

**Testing Patterns:**
- Unit tests for SharePoint service (mock Graph API client)
- Integration tests for SharePoint connectivity
- Test form submission to SharePoint
- Test OneDrive sync
- Test error handling scenarios
- Test permission handling

**Test Coverage Target:** >80% for business logic [Source: docs/architecture.md#testing-strategy]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-19 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent - will list all files created/modified during implementation_

## QA Results

_This section will be populated by the QA Agent after review_

